import{proxyCustomElement,HTMLElement,createEvent,h}from"@stencil/core/internal/client";import{s as state,r as removeQueryArgs}from"./mutations.js";import{c as clearCheckout}from"./mutations2.js";import{s as state$1}from"./watchers4.js";import{u as updateFormState}from"./mutations3.js";import{p as parseFormData}from"./form-data.js";import{f as finalizeCheckout,g as fetchCheckout,d as createOrUpdateCheckout}from"./index4.js";import{r as removeNotice,c as createErrorNotice,a as createInfoNotice}from"./mutations4.js";import{d as defineCustomElement$1}from"./sc-line-items-provider2.js";import{a as addQueryArgs,g as getQueryArgs}from"./add-query-args.js";import{g as getQueryArg}from"./get-query-arg.js";const ScSessionProvider=proxyCustomElement(class extends HTMLElement{constructor(){super(),this.__registerHost(),this.__attachShadow(),this.scUpdateOrderState=createEvent(this,"scUpdateOrderState",7),this.scUpdateDraftState=createEvent(this,"scUpdateDraftState",7),this.scPaid=createEvent(this,"scPaid",7),this.scSetState=createEvent(this,"scSetState",7),this.prices=[],this.persist=!0}handlePricesChange(){let e=this.addInitialPrices()||[];if(null==e?void 0:e.length)return this.loadUpdate({line_items:e})}async finalize(){return await this.handleFormSubmit()}async getFormData(){let e={};const t=this.el.querySelector("sc-form");if(t){const o=await t.getFormJson();e=parseFormData(o)}return e}async handleFormSubmit(){var e,t,o,a,i,r,s,n,d;removeNotice(),updateFormState("FINALIZE");let c=await this.getFormData();if((null===(e=null===window||void 0===window?void 0:window.scData)||void 0===e?void 0:e.recaptcha_site_key)&&(null===window||void 0===window?void 0:window.grecaptcha))try{c.grecaptcha=await window.grecaptcha.execute(window.scData.recaptcha_site_key,{action:"surecart_checkout_submit"})}catch(e){return console.error(e),updateFormState("REJECT"),this.handleErrorResponse(e),new Error(null==e?void 0:e.message)}try{await this.update(c)}catch(e){console.error(e),updateFormState("REJECT"),this.handleErrorResponse(e)}try{return state.checkout=await finalizeCheckout({id:null===(t=null==state?void 0:state.checkout)||void 0===t?void 0:t.id,query:{...(null==state$1?void 0:state$1.method)?{payment_method_type:null==state$1?void 0:state$1.method}:{},return_url:addQueryArgs(window.location.href,{...(null===(o=null==state?void 0:state.checkout)||void 0===o?void 0:o.id)?{checkout_id:null===(a=null==state?void 0:state.checkout)||void 0===a?void 0:a.id}:{},is_surecart_payment_redirect:!0})},data:c,processor:{id:state$1.id,manual:state$1.manual}}),["paid","processing"].includes(null===(i=state.checkout)||void 0===i?void 0:i.status)&&this.scPaid.emit(),(null===(d=null===(n=null===(s=null===(r=state.checkout)||void 0===r?void 0:r.payment_intent)||void 0===s?void 0:s.processor_data)||void 0===n?void 0:n.mollie)||void 0===d?void 0:d.checkout_url)?(updateFormState("PAYING"),setTimeout((()=>{var e,t,o,a;return window.location.assign(null===(a=null===(o=null===(t=null===(e=state.checkout)||void 0===e?void 0:e.payment_intent)||void 0===t?void 0:t.processor_data)||void 0===o?void 0:o.mollie)||void 0===a?void 0:a.checkout_url)}),50)):(setTimeout((()=>{updateFormState("PAYING")}),50),state.checkout)}catch(e){return console.error(e),this.handleErrorResponse(e),new Error(null==e?void 0:e.message)}}async handlePaid(){updateFormState("PAID")}async handleAbandonedCartUpdate(e){const t=e.detail;this.loadUpdate({abandoned_checkout_enabled:t})}async handleCouponApply(e){const t=e.detail;removeNotice(),this.loadUpdate({discount:{...t?{promotion_code:t}:{}}})}componentDidLoad(){this.findOrCreateOrder()}async findOrCreateOrder(){var e;const{redirect_status:t,checkout_id:o,line_items:a,coupon:i,is_surecart_payment_redirect:r}=getQueryArgs(window.location.href);if(window.history.replaceState({},document.title,removeQueryArgs(window.location.href,"redirect_status","coupon","line_items","confirm_checkout_id","checkout_id","no_cart")),r&&o)return updateFormState("FINALIZE"),updateFormState("PAYING"),this.handleCheckoutIdFromUrl(o,i);if(t)return this.handleRedirectStatus(t,o);if(o)return this.handleCheckoutIdFromUrl(o,i);if(a)return this.handleInitialLineItems(a,i);const s=null===(e=null==state?void 0:state.checkout)||void 0===e?void 0:e.id;return s&&this.persist?this.handleExistingCheckout(s,i):this.handleNewCheckout(i)}async handleRedirectStatus(e,t){var o,a;if(console.info("Handling payment redirect."),"failed"!==e)if(t)try{updateFormState("FINALIZE"),updateFormState("PAID"),state.checkout=await fetchCheckout({id:t,query:{refresh_status:!0}}),(null===(o=state.checkout)||void 0===o?void 0:o.status)&&["paid","processing"].includes(null===(a=state.checkout)||void 0===a?void 0:a.status)&&setTimeout((()=>{this.scPaid.emit()}),100)}catch(e){this.handleErrorResponse(e)}else createErrorNotice(wp.i18n.__("Could not find checkout. Please contact us before attempting to purchase again.","surecart"));else createErrorNotice(wp.i18n.__("Payment unsuccessful. Please try again.","surecart"))}async handleCheckoutIdFromUrl(e,t=""){var o,a;if(console.info("Handling existing checkout from url.",t,e),t)return this.loadUpdate({id:e,discount:{promotion_code:t},refresh_price_versions:!0});try{if(updateFormState("FETCH"),state.checkout=await fetchCheckout({id:e,query:{refresh_status:!0}}),state.mode!==((null===(o=state.checkout)||void 0===o?void 0:o.live_mode)?"live":"test"))return console.info("Mode mismatch, creating new checkout."),clearCheckout(),state.checkout=null,void await this.handleNewCheckout(t);updateFormState("RESOLVE")}catch(e){this.handleErrorResponse(e)}switch(null===(a=state.checkout)||void 0===a?void 0:a.status){case"paid":case"processing":return setTimeout((()=>{updateFormState("FINALIZE"),updateFormState("PAID"),this.scPaid.emit()}),100);case"payment_failed":return clearCheckout(),void createErrorNotice({message:wp.i18n.__("Payment unsuccessful. Please try again.","surecart")});case"payment_intent_canceled":case"canceled":return clearCheckout(),void createErrorNotice({message:wp.i18n.__("Payment canceled. Please try again.","surecart")});case"finalized":return createErrorNotice({message:wp.i18n.__("Payment unsuccessful. Please try again.","surecart")}),void updateFormState("REJECT")}}async handleInitialLineItems(e,t){console.info("Handling initial line items.");const o=this.el.querySelector("sc-order-shipping-address");return clearCheckout(),this.loadUpdate({line_items:e,refresh_price_versions:!0,...t?{discount:{promotion_code:t}}:{},...(null==o?void 0:o.defaultCountry)?{shipping_address:{country:null==o?void 0:o.defaultCountry}}:{}})}async handleNewCheckout(e){var t;const o=this.getFormData();let a=state.initialLineItems||[];const i=this.el.querySelector("sc-order-shipping-address");try{updateFormState("FETCH"),state.checkout=await createOrUpdateCheckout({data:{...o,...e?{discount:{promotion_code:e}}:{},...(null==i?void 0:i.defaultCountry)?{shipping_address:{country:null==i?void 0:i.defaultCountry}}:{},line_items:a,...(null===(t=state.taxProtocol)||void 0===t?void 0:t.eu_vat_required)?{tax_identifier:{number_type:"eu_vat"}}:{}}}),updateFormState("RESOLVE")}catch(e){console.error(e),this.handleErrorResponse(e)}}async handleExistingCheckout(e,t){var o;if(!e)return this.handleNewCheckout(t);console.info("Handling existing checkout.");try{updateFormState("FETCH"),state.checkout=await createOrUpdateCheckout({id:e,data:{...t?{discount:{promotion_code:t}}:{},refresh_price_versions:!0,...(null===(o=state.taxProtocol)||void 0===o?void 0:o.eu_vat_required)?{tax_identifier:{number_type:"eu_vat"}}:{}}}),updateFormState("RESOLVE")}catch(e){console.error(e),this.handleErrorResponse(e)}}async handleErrorResponse(e){var t,o,a,i;if(["checkout.not_found"].includes(null==e?void 0:e.code))return window.history.replaceState({},document.title,removeQueryArgs(window.location.href,"checkout_id")),clearCheckout(),this.handleNewCheckout(!1);if(((null==e?void 0:e.additional_errors)||[]).some((e=>"checkout.price.old_version"==(null==e?void 0:e.code))))return await this.loadUpdate({id:null===(t=null==state?void 0:state.checkout)||void 0===t?void 0:t.id,data:{status:"draft",refresh_price_versions:!0}}),void createInfoNotice(wp.i18n.__("The price a product in your order has changed. We have adjusted your order to the new price.","surecart"));if("checkout.product.out_of_stock"===(null===(a=null===(o=null==e?void 0:e.additional_errors)||void 0===o?void 0:o[0])||void 0===a?void 0:a.code))return this.fetch(),void updateFormState("REJECT");if(["order.invalid_status_transition"].includes(null==e?void 0:e.code))return await this.loadUpdate({id:null===(i=null==state?void 0:state.checkout)||void 0===i?void 0:i.id,data:{status:"draft"}}),void this.handleFormSubmit();if("rest_cookie_invalid_nonce"!==(null==e?void 0:e.code)){if("readonly"===(null==e?void 0:e.code))return clearCheckout(),void window.location.assign(removeQueryArgs(window.location.href,"order"));createErrorNotice(e),updateFormState("REJECT")}else updateFormState("EXPIRE")}async initialize(e={}){let t=state.initialLineItems||[];return this.loadUpdate({...(null==t?void 0:t.length)?{line_items:t}:{},...e})}addInitialPrices(){var e;return(null===(e=null==this?void 0:this.prices)||void 0===e?void 0:e.length)?this.prices.some((e=>!(null==e?void 0:e.id)))?void 0:this.prices.map((e=>({price_id:e.id,quantity:e.quantity,variant:e.variant}))):[]}getSessionId(){var e,t;return getQueryArg(window.location.href,"checkout_id")||((null===(e=null==state?void 0:state.checkout)||void 0===e?void 0:e.id)?null===(t=null==state?void 0:state.checkout)||void 0===t?void 0:t.id:null)}async fetchCheckout(e,{query:t={},data:o={}}={}){try{updateFormState("FETCH");const a=await createOrUpdateCheckout({id:e,query:t,data:o});return updateFormState("RESOLVE"),a}catch(e){this.handleErrorResponse(e)}}async fetch(e={}){try{updateFormState("FETCH"),state.checkout=await fetchCheckout({id:this.getSessionId(),query:e}),updateFormState("RESOLVE")}catch(e){this.handleErrorResponse(e)}}async update(e={},t={}){try{state.checkout=await createOrUpdateCheckout({id:(null==e?void 0:e.id)?e.id:this.getSessionId(),data:e,query:t})}catch(e){if(["checkout.not_found"].includes(null==e?void 0:e.code))return clearCheckout(),this.initialize();throw console.error(e),e}}async loadUpdate(e={}){try{updateFormState("FETCH"),await this.update(e),updateFormState("RESOLVE")}catch(e){this.handleErrorResponse(e)}}render(){return h("sc-line-items-provider",{order:null==state?void 0:state.checkout,onScUpdateLineItems:e=>this.loadUpdate({line_items:e.detail})},h("slot",null))}get el(){return this}static get watchers(){return{prices:["handlePricesChange"]}}},[1,"sc-session-provider",{prices:[16],persist:[4],finalize:[64]},[[0,"scFormSubmit","handleFormSubmit"],[0,"scPaid","handlePaid"],[0,"scUpdateAbandonedCart","handleAbandonedCartUpdate"],[0,"scApplyCoupon","handleCouponApply"]]]);function defineCustomElement(){"undefined"!=typeof customElements&&["sc-session-provider","sc-line-items-provider"].forEach((e=>{switch(e){case"sc-session-provider":customElements.get(e)||customElements.define(e,ScSessionProvider);break;case"sc-line-items-provider":customElements.get(e)||defineCustomElement$1()}}))}export{ScSessionProvider as S,defineCustomElement as d};