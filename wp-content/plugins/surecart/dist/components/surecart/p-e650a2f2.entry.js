import{r as i,c as t,h as o,a as d}from"./p-cc7ce8c7.js";import{p as l}from"./p-f0bb2283.js";import{o as s}from"./p-2f9b1dd9.js";import{c as e,f as n}from"./p-9a954102.js";import{c as v}from"./p-05fc1ee0.js";import"./p-112455b1.js";import"./p-2934ec66.js";import"./p-25433d0f.js";import"./p-f70181c4.js";import"./p-4d73f82a.js";import"./p-1c2e2695.js";import"./p-7ef0f71c.js";import"./p-18e45a13.js";import"./p-09484d0e.js";const r=":host{display:block}.or{display:none;margin:var(--sc-form-section-spacing) 0}.request--loaded .or{display:block}";const u=class{constructor(o){i(this,o);this.scFormSubmit=t(this,"scFormSubmit",7);this.scPaid=t(this,"scPaid",7);this.scPayError=t(this,"scPayError",7);this.scSetState=t(this,"scSetState",7);this.scPaymentRequestLoaded=t(this,"scPaymentRequestLoaded",7);this.scUpdateOrderState=t(this,"scUpdateOrderState",7);this.stripeAccountId=undefined;this.publishableKey=undefined;this.country="US";this.currencyCode="usd";this.order=undefined;this.prices=undefined;this.label="total";this.amount=0;this.theme="dark";this.error=undefined;this.paymentMethod=undefined;this.debug=false;this.formId=undefined;this.loaded=false;this.debugError=undefined}async componentWillLoad(){if(!(this===null||this===void 0?void 0:this.publishableKey)||!(this===null||this===void 0?void 0:this.stripeAccountId)){return true}try{this.stripe=await l.loadStripe(this.publishableKey,{stripeAccount:this.stripeAccountId});this.elements=this.stripe.elements();this.paymentRequest=this.stripe.paymentRequest({country:this.country,requestShipping:true,requestPayerEmail:true,shippingOptions:[{id:"free",label:"Free Shipping",detail:"No shipping required",amount:0}],...this.getRequestObject(this.order)})}catch(i){console.log((i===null||i===void 0?void 0:i.message)||wp.i18n.__("Stripe could not be loaded","surecart"))}}handleOrderChange(){if(!this.paymentRequest)return;if(this.pendingEvent)return;this.paymentRequest.update(this.getRequestObject(this.order))}handleLoaded(){this.scPaymentRequestLoaded.emit(true)}handleErrorChange(){if(this.pendingEvent){this.pendingEvent.complete("error")}}async handleShippingChange(i){var t,o,d,l,s;const{shippingAddress:n,updateWith:v}=i;try{const i=await e({id:(t=this.order)===null||t===void 0?void 0:t.id,data:{shipping_address:{...(n===null||n===void 0?void 0:n.name)?{name:n===null||n===void 0?void 0:n.name}:{},...((o=n===null||n===void 0?void 0:n.addressLine)===null||o===void 0?void 0:o[0])?{line_1:(d=n===null||n===void 0?void 0:n.addressLine)===null||d===void 0?void 0:d[0]}:{},...((l=n===null||n===void 0?void 0:n.addressLine)===null||l===void 0?void 0:l[1])?{line_2:(s=n===null||n===void 0?void 0:n.addressLine)===null||s===void 0?void 0:s[1]}:{},...(n===null||n===void 0?void 0:n.city)?{city:n===null||n===void 0?void 0:n.city}:{},...(n===null||n===void 0?void 0:n.country)?{country:n===null||n===void 0?void 0:n.country}:{},...(n===null||n===void 0?void 0:n.postalCode)?{postal_code:n===null||n===void 0?void 0:n.postalCode}:{},...(n===null||n===void 0?void 0:n.region)?{state:n===null||n===void 0?void 0:n.region}:{}}}});v({status:"success",total:{amount:(i===null||i===void 0?void 0:i.amount_due)||0,label:wp.i18n.__("Total","surecart"),pending:true}})}catch(i){i.updateWith({status:"invalid_shipping_address"})}}getName(i){var t,o,d,l,s;const e=Object.keys(this.prices||{}).filter((t=>{const o=this.prices[t];return o.product===i.price.product.id}));let n="";if(e.length>1){n=`${(o=(t=i===null||i===void 0?void 0:i.price)===null||t===void 0?void 0:t.product)===null||o===void 0?void 0:o.name} â€“ ${(d=i===null||i===void 0?void 0:i.price)===null||d===void 0?void 0:d.name}`}else{n=(s=(l=i===null||i===void 0?void 0:i.price)===null||l===void 0?void 0:l.product)===null||s===void 0?void 0:s.name}return n}getRequestObject(i){var t;const o=(((t=i===null||i===void 0?void 0:i.line_items)===null||t===void 0?void 0:t.data)||[]).map((i=>({label:this.getName(i),amount:i.ad_hoc_amount!==null?i.ad_hoc_amount:i.subtotal_amount})));return{currency:this.currencyCode,total:{amount:(i===null||i===void 0?void 0:i.amount_due)||0,label:wp.i18n.__("Total","surecart"),pending:true},displayItems:o}}componentDidLoad(){if(!this.elements){return}const i=this.elements.create("paymentRequestButton",{paymentRequest:this.paymentRequest,style:{paymentRequestButton:{theme:this.theme}}});this.paymentRequest.on("paymentmethod",(i=>this.handlePaymentMethod(i)));this.paymentRequest.on("shippingaddresschange",(async i=>await this.handleShippingChange(i)));this.paymentRequest.canMakePayment().then((t=>{if(!t){if(location.protocol!=="https:"){if(this.debug){this.debugError=wp.i18n.__("You must serve this page over HTTPS to display express payment buttons.","surecart")}console.log("SSL needed to display payment buttons.")}else{if(this.debug){this.debugError=wp.i18n.__("You do not have any wallets set up in your browser.","surecart")}console.log("No wallets available.")}return}i.mount(this.request);this.loaded=true})).catch((i=>{console.error(i)}))}async handlePaymentMethod(i){var t,o,d,l,s;const{billing_details:r}=i===null||i===void 0?void 0:i.paymentMethod;const{shippingAddress:u}=i;try{this.scSetState.emit("FINALIZE");await e({id:(t=this.order)===null||t===void 0?void 0:t.id,data:{email:r===null||r===void 0?void 0:r.email,name:r===null||r===void 0?void 0:r.name,shipping_address:{...(u===null||u===void 0?void 0:u.name)?{name:u===null||u===void 0?void 0:u.name}:{},...((o=u===null||u===void 0?void 0:u.addressLine)===null||o===void 0?void 0:o[0])?{line_1:(d=u===null||u===void 0?void 0:u.addressLine)===null||d===void 0?void 0:d[0]}:{},...((l=u===null||u===void 0?void 0:u.addressLine)===null||l===void 0?void 0:l[1])?{line_2:(s=u===null||u===void 0?void 0:u.addressLine)===null||s===void 0?void 0:s[1]}:{},...(u===null||u===void 0?void 0:u.city)?{city:u===null||u===void 0?void 0:u.city}:{},...(u===null||u===void 0?void 0:u.country)?{country:u===null||u===void 0?void 0:u.country}:{},...(u===null||u===void 0?void 0:u.postalCode)?{postal_code:u===null||u===void 0?void 0:u.postalCode}:{},...(u===null||u===void 0?void 0:u.region)?{state:u===null||u===void 0?void 0:u.region}:{}}}});const v=await n({id:this.order.id,query:{form_id:this.formId},processor:{id:"stripe",manual:false}});this.scSetState.emit("PAYING");await this.confirmPayment(v,i);this.scSetState.emit("PAID");this.scPaid.emit();i.complete("success")}catch(t){console.error(t);this.scPayError.emit(t);v(t);i.complete("fail")}finally{this.confirming=false}}async confirmPayment(i,t){var o,d,l,s,e,n,v,r,u,a,h,c,p,m,f,y,g,b;if((i===null||i===void 0?void 0:i.status)!=="finalized")return;if(!((l=(d=(o=i===null||i===void 0?void 0:i.payment_intent)===null||o===void 0?void 0:o.processor_data)===null||d===void 0?void 0:d.stripe)===null||l===void 0?void 0:l.client_secret))return;if(!((n=(e=(s=i===null||i===void 0?void 0:i.payment_intent)===null||s===void 0?void 0:s.processor_data)===null||e===void 0?void 0:e.stripe)===null||n===void 0?void 0:n.type))return;if(!((v=i===null||i===void 0?void 0:i.payment_intent)===null||v===void 0?void 0:v.external_intent_id))return;if(this.confirming)return;this.confirming=true;let w;if(((a=(u=(r=i===null||i===void 0?void 0:i.payment_intent)===null||r===void 0?void 0:r.processor_data)===null||u===void 0?void 0:u.stripe)===null||a===void 0?void 0:a.type)=="setup"){w=await this.confirmCardSetup((c=(h=i===null||i===void 0?void 0:i.payment_intent)===null||h===void 0?void 0:h.processor_data)===null||c===void 0?void 0:c.stripe.client_secret,t)}else{w=await this.confirmCardPayment((m=(p=i===null||i===void 0?void 0:i.payment_intent)===null||p===void 0?void 0:p.processor_data)===null||m===void 0?void 0:m.stripe.client_secret,t)}if(w===null||w===void 0?void 0:w.error){throw w.error}if(((f=w===null||w===void 0?void 0:w.paymentIntent)===null||f===void 0?void 0:f.status)==="requires_action"||((y=w===null||w===void 0?void 0:w.paymentIntent)===null||y===void 0?void 0:y.status)==="requires_source_action"){const t=await this.stripe.confirmCardPayment((b=(g=i===null||i===void 0?void 0:i.payment_intent)===null||g===void 0?void 0:g.processor_data)===null||b===void 0?void 0:b.stripe.client_secret);if(t.error){throw t.error}return t}return w}confirmCardPayment(i,t){return this.stripe.confirmCardPayment(i,{payment_method:t.paymentMethod.id},{handleActions:false})}confirmCardSetup(i,t){return this.stripe.confirmCardSetup(i,{payment_method:t.paymentMethod.id},{handleActions:false})}render(){return o("div",{class:{request:true,"request--loaded":this.loaded}},this.debug&&this.debugError&&o("div",null,o("slot",{name:"debug-fallback"}),o("sc-alert",{type:"info",open:true},o("span",{slot:"title"},wp.i18n.__("Express Payment","surecart")),this.debugError)),o("div",{class:"sc-payment-request-button",part:"button",ref:i=>this.request=i}))}get el(){return d(this)}static get watchers(){return{order:["handleOrderChange"],loaded:["handleLoaded"],error:["handleErrorChange"]}}};s(u,["currencyCode","country","prices","paymentMethod"],false);u.style=r;export{u as sc_stripe_payment_request};
//# sourceMappingURL=p-e650a2f2.entry.js.map