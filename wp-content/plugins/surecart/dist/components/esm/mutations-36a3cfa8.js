import{c as createStore}from"./index-1046c77e.js";import{g as getSerializedState}from"./utils-00526fde.js";import{g as getQueryArg}from"./get-query-arg-cb6b8763.js";import{m as maybeConvertAmount}from"./currency-728311ef.js";import{g as getQueryArgs,b as buildQueryString,a as addQueryArgs}from"./add-query-args-f4c5962b.js";const safeRead=(t,o)=>{try{return JSON.parse(t.getItem(o))}catch{return null}},debounce=t=>{let o=!1;return()=>{o||(o=!0,setTimeout((()=>{t(),o=!1}),0))}},createStorageStore=(t,o,n,i=!1)=>{var e;const d=createStore(null!==(e=safeRead(t,o))&&void 0!==e?e:n,((t,o)=>JSON.stringify(t)!==JSON.stringify(o))),u=debounce((()=>t.setItem(o,JSON.stringify(d.state))));return u(),i&&window.addEventListener("storage",(()=>{const n=safeRead(t,o);if(null!==n)for(const t in n)d.set(t,n[t])})),d.use({set:u,reset:u}),d},createLocalStore=(t,o,n=!1)=>createStorageStore(localStorage,t,o,n);function removeQueryArgs(t){const o=t.indexOf("?");if(-1===o)return t;const n=getQueryArgs(t),i=t.substr(0,o);for(var e=arguments.length,d=new Array(e>1?e-1:0),u=1;u<e;u++)d[u-1]=arguments[u];d.forEach((t=>delete n[t]));const l=buildQueryString(n);return l?i+"?"+l:i}const{checkout:checkout$1}=getSerializedState(),notPersistCart="browser"!==(null==checkout$1?void 0:checkout$1.persist)||!!getQueryArg(window.location.href,"no_cart"),store=notPersistCart?createStore({live:{},test:{}}):createLocalStore("surecart-local-storage",{live:{},test:{}},!0),{state:state$1,onChange:onChange$1,on:on$1,set:set$1,get:get$1,dispose:dispose$1}=store;window.scStore=store;const{checkout:checkout}=getSerializedState(),{state:state,onChange:onChange,on:on,set:set,get:get,dispose:dispose}=createStore({formId:null,groupId:null,mode:"live",locks:[],product:null,checkout:null,currencyCode:"usd",abandonedCheckoutEnabled:!0,initialLineItems:[],isCheckoutPage:!1,validateStock:!1,persist:"browser",...checkout},((t,o)=>JSON.stringify(t)!==JSON.stringify(o)));onChange("checkout",(t=>setCheckout(t,state.formId))),on("get",(t=>{if("checkout"===t){const t=getCheckout(state.formId,state.mode);(null==t?void 0:t.id)&&(state.checkout=t)}})),on$1("set",((t,o,n)=>Object.keys(o||{}).forEach((t=>handleCheckoutLineItemChange(o[t],null==n?void 0:n[t])))));const handleCheckoutLineItemChange=(t,o)=>{var n,i;const e=(null===(n=null==t?void 0:t.line_items)||void 0===n?void 0:n.data)||[],d=(null===(i=null==o?void 0:o.line_items)||void 0===i?void 0:i.data)||[];if(e.forEach((t=>{const o=d.find((o=>o.id===t.id));if(!o||(null==o?void 0:o.quantity)<(null==t?void 0:t.quantity)){const n=new CustomEvent("scAddedToCart",{detail:{...t,quantity:t.quantity-((null==o?void 0:o.quantity)||0)},bubbles:!0});document.dispatchEvent(n)}})),d.forEach((t=>{const o=e.find((o=>o.id===t.id));if(!o||(null==t?void 0:t.quantity)>(null==o?void 0:o.quantity)){const n=new CustomEvent("scRemovedFromCart",{detail:{...t,quantity:t.quantity-((null==o?void 0:o.quantity)||0)},bubbles:!0});document.dispatchEvent(n)}})),JSON.stringify(e)!==JSON.stringify(d)){const n=new CustomEvent("scCartUpdated",{detail:[t,o],bubbles:!0});document.dispatchEvent(n)}};on("set",((t,o,n)=>{var i,e,d,u,l;if("checkout"!==t)return;if(null==n?void 0:n.id)return;if(!(null==o?void 0:o.id))return;if(!state.isCheckoutPage)return;const r=new CustomEvent("scCheckoutInitiated",{detail:{transaction_id:o.id,value:maybeConvertAmount(null==o?void 0:o.total_amount,(null==o?void 0:o.currency)||"USD"),currency:(o.currency||"").toUpperCase(),...(null===(e=null===(i=null==o?void 0:o.discount)||void 0===i?void 0:i.promotion)||void 0===e?void 0:e.code)?{coupon:null===(u=null===(d=null==o?void 0:o.discount)||void 0===d?void 0:d.promotion)||void 0===u?void 0:u.code}:{},...(null==o?void 0:o.tax_amount)?{tax:maybeConvertAmount(null==o?void 0:o.tax_amount,(null==o?void 0:o.currency)||"USD")}:{},items:((null===(l=null==o?void 0:o.line_items)||void 0===l?void 0:l.data)||[]).map((t=>{var n,i,e,d,u;return{item_name:(null===(i=null===(n=null==t?void 0:t.price)||void 0===n?void 0:n.product)||void 0===i?void 0:i.name)||"",item_id:null===(d=null===(e=null==t?void 0:t.price)||void 0===e?void 0:e.product)||void 0===d?void 0:d.id,discount:(null==t?void 0:t.discount_amount)?maybeConvertAmount((null==t?void 0:t.discount_amount)||0,(null==o?void 0:o.currency)||"USD"):0,price:maybeConvertAmount((null===(u=null==t?void 0:t.price)||void 0===u?void 0:u.amount)||0,(null==o?void 0:o.currency)||"USD"),quantity:(null==t?void 0:t.quantity)||1}}))},bubbles:!0});document.dispatchEvent(r)})),on("set",((t,o,n)=>{var i,e;if("checkout"!==t)return;if(!(null==o?void 0:o.status)||(null==n?void 0:n.status)===(null==o?void 0:o.status))return;if(!["paid","processing"].includes(o.status))return;const d=new CustomEvent("scOrderPaid",{detail:o,bubbles:!0});document.dispatchEvent(d);const u=new CustomEvent("scCheckoutCompleted",{detail:o,bubbles:!0});document.dispatchEvent(u);const l=((null===(i=null==o?void 0:o.line_items)||void 0===i?void 0:i.data)||[]).filter((t=>{var o;return(null===(o=null==t?void 0:t.price)||void 0===o?void 0:o.trial_duration_days)>0}));if(l.length>0){const t=new CustomEvent("scTrialStarted",{detail:l,bubbles:!0});document.dispatchEvent(t)}const r=((null===(e=null==o?void 0:o.line_items)||void 0===e?void 0:e.data)||[]).filter((t=>{var o;return(null===(o=null==t?void 0:t.price)||void 0===o?void 0:o.recurring_interval_count)>0}));if(r.length>0){const t=new CustomEvent("scSubscriptionStarted",{detail:r,bubbles:!0});document.dispatchEvent(t)}})),window.addEventListener("scAddedToCart",(function(t){var o,n,i,e,d,u,l,r,a;if(!(null===window||void 0===window?void 0:window.dataLayer)&&!(null===window||void 0===window?void 0:window.gtag))return;const c=t.detail;if(!(null===(o=null==c?void 0:c.price)||void 0===o?void 0:o.product))return;const v=[{item_id:null===(i=null===(n=c.price)||void 0===n?void 0:n.product)||void 0===i?void 0:i.id,item_name:null===(d=null===(e=c.price)||void 0===e?void 0:e.product)||void 0===d?void 0:d.name,item_variant:(c.variant_options||[]).join(" / "),price:maybeConvertAmount((null===(u=null==c?void 0:c.price)||void 0===u?void 0:u.amount)||0,(null===(l=c.price)||void 0===l?void 0:l.currency)||"USD"),currency:null===(r=c.price)||void 0===r?void 0:r.currency,quantity:c.quantity,discount:(null==c?void 0:c.discount_amount)?maybeConvertAmount((null==c?void 0:c.discount_amount)||0,(null===(a=c.price)||void 0===a?void 0:a.currency)||"USD"):0}];(null===window||void 0===window?void 0:window.gtag)&&window.gtag("event","add_to_cart",{items:v}),(null===window||void 0===window?void 0:window.dataLayer)&&(window.dataLayer.push({ecommerce:null}),window.dataLayer.push({event:"add_to_cart",ecommerce:{data:{items:v}}}))})),window.addEventListener("scCheckoutCompleted",(function(t){var o,n,i,e,d;if(!(null===window||void 0===window?void 0:window.dataLayer)&&!(null===window||void 0===window?void 0:window.gtag))return;const u=t.detail,l={transaction_id:null==u?void 0:u.id,value:maybeConvertAmount(null==u?void 0:u.total_amount,(null==u?void 0:u.currency)||"USD"),currency:(u.currency||"").toUpperCase(),...(null===(n=null===(o=null==u?void 0:u.discount)||void 0===o?void 0:o.promotion)||void 0===n?void 0:n.code)?{coupon:null===(e=null===(i=null==u?void 0:u.discount)||void 0===i?void 0:i.promotion)||void 0===e?void 0:e.code}:{},...(null==u?void 0:u.tax_amount)?{tax:maybeConvertAmount(null==u?void 0:u.tax_amount,(null==u?void 0:u.currency)||"USD")}:{},items:((null===(d=null==u?void 0:u.line_items)||void 0===d?void 0:d.data)||[]).map((t=>{var o,n,i,e,d,l,r;return{item_id:null===(n=null===(o=null==t?void 0:t.price)||void 0===o?void 0:o.product)||void 0===n?void 0:n.id,currency:(u.currency||"").toUpperCase(),item_name:(null===(e=null===(i=null==t?void 0:t.price)||void 0===i?void 0:i.product)||void 0===e?void 0:e.name)||"",discount:(null==t?void 0:t.discount_amount)?maybeConvertAmount((null==t?void 0:t.discount_amount)||0,(null===(d=null==t?void 0:t.price)||void 0===d?void 0:d.currency)||"USD"):0,price:maybeConvertAmount((null===(l=null==t?void 0:t.price)||void 0===l?void 0:l.amount)||0,(null===(r=null==t?void 0:t.price)||void 0===r?void 0:r.currency)||"USD"),quantity:(null==t?void 0:t.quantity)||1,item_variant:(t.variant_options||[]).join(" / ")}}))};(null===window||void 0===window?void 0:window.gtag)&&window.gtag("event","purchase",l),(null===window||void 0===window?void 0:window.dataLayer)&&(window.dataLayer.push({ecommerce:null}),window.dataLayer.push({event:"purchase",ecommerce:l}))})),window.addEventListener("scAddedToCart",(function(t){var o,n,i,e,d,u,l,r;if(!(null===window||void 0===window?void 0:window.fbq))return;const a=t.detail;if(!(null===(o=null==a?void 0:a.price)||void 0===o?void 0:o.product))return;const c=null===(n=null==a?void 0:a.price)||void 0===n?void 0:n.product,v=(null===(e=null===(i=null==c?void 0:c.product_collections)||void 0===i?void 0:i.data)||void 0===e?void 0:e.map((t=>t.name)))||[];window.fbq("track","AddToCart",{...v.length?{content_category:v.join(", ")}:{},content_ids:[c.id],content_name:(null==c?void 0:c.name)+((null===(d=null==a?void 0:a.variant_options)||void 0===d?void 0:d.length)?` - ${null==a?void 0:a.variant_options.join(" / ")}`:""),content_type:"product",contents:[{id:c.id,quantity:a.quantity}],currency:null===(u=null==a?void 0:a.price)||void 0===u?void 0:u.currency,value:maybeConvertAmount((null===(l=null==a?void 0:a.price)||void 0===l?void 0:l.amount)||0,(null===(r=null==a?void 0:a.price)||void 0===r?void 0:r.currency)||"USD")})})),window.addEventListener("scCheckoutInitiated",(function(t){var o,n,i;if(!(null===window||void 0===window?void 0:window.fbq))return;const e=t.detail;window.fbq("track","InitiateCheckout",{content_ids:null===(o=null==e?void 0:e.items)||void 0===o?void 0:o.map((t=>t.item_id)),contents:null===(n=null==e?void 0:e.items)||void 0===n?void 0:n.map((t=>({id:t.item_id,quantity:t.quantity}))),currency:null==e?void 0:e.currency,num_items:null===(i=null==e?void 0:e.items)||void 0===i?void 0:i.length,value:e.value})})),window.addEventListener("scCheckoutCompleted",(function(t){var o,n,i;if(!(null===window||void 0===window?void 0:window.fbq))return;const e=t.detail;window.fbq("track","Purchase",{content_ids:null===(o=null==e?void 0:e.items)||void 0===o?void 0:o.map((t=>t.item_id)),content_name:"Purchase",content_type:"product",contents:null===(n=null==e?void 0:e.items)||void 0===n?void 0:n.map((t=>({id:t.item_id,quantity:t.quantity}))),currency:null==e?void 0:e.currency,num_items:null===(i=null==e?void 0:e.items)||void 0===i?void 0:i.length,value:maybeConvertAmount(null==e?void 0:e.total_amount,(null==e?void 0:e.currency)||"USD")})})),window.addEventListener("scTrialStarted",(function(t){(null===window||void 0===window?void 0:window.fbq)&&t.detail.forEach((t=>{var o,n,i;window.fbq("track","StartTrial",{currency:null===(o=t.price)||void 0===o?void 0:o.currency,value:maybeConvertAmount((null===(n=t.price)||void 0===n?void 0:n.amount)||0,(null===(i=t.price)||void 0===i?void 0:i.currency)||"USD")})}))})),window.addEventListener("scSubscriptionStarted",(function(t){(null===window||void 0===window?void 0:window.fbq)&&t.detail.forEach((t=>{var o,n,i;window.fbq("track","Subscribe",{currency:null===(o=t.price)||void 0===o?void 0:o.currency,value:maybeConvertAmount((null===(n=t.price)||void 0===n?void 0:n.amount)||0,(null===(i=t.price)||void 0===i?void 0:i.currency)||"USD")})}))})),window.addEventListener("scPaymentInfoAdded",(function(t){if(!(null===window||void 0===window?void 0:window.fbq))return;const o=t.detail;window.fbq("track","AddPaymentInfo",{content_category:"Payment Info Added",currency:null==o?void 0:o.currency})}));const getCheckout=(t,o)=>{var n;return(null===(n=store.state[o])||void 0===n?void 0:n[t])||{}},setCheckout=(t,o)=>{const n=(null==t?void 0:t.live_mode)?"live":"test";store.set(n,{...store.state[n],[o]:t}),state.formId===o&&state.mode===n&&(state.checkout=t),"url"===state.persist&&(null==t?void 0:t.id)&&window.history.replaceState({},document.title,addQueryArgs(window.location.href,{checkout_id:null==t?void 0:t.id}))},clearCheckout=(t,o)=>{const{[t]:n,...i}=store.state[o];return window.history.replaceState({},document.title,removeQueryArgs(window.location.href,"redirect_status","coupon","line_items","confirm_checkout_id","checkout_id")),store.set(o,i)};export{setCheckout as a,onChange$1 as b,clearCheckout as c,on as d,getCheckout as g,onChange as o,removeQueryArgs as r,state as s};